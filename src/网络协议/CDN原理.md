# CDN 原理
### CDN
  内容分发网络（content delivery network），建立在承载网基础上的虚拟分布式网络，能够将**源站内容**（包括各类动静态资源）智能缓存到全球各**节点服务器**上

#### 优势
- 就近访问内容，提高资源访问速度；
- 分担源站压力；

### 加速域名
需要使用CDN加速的域名，也是一个域名，一般配置CNAME 记录，指向CDN网络节点。普通域名一般配置A记录，指向提供服务的业务服务器；

### CNAME记录、A 记录和NS记录

DNS提供了将域名转化成IP的服务，为了完成这个转化工作，DNS数据哭需要维护相关的数据，这些数据叫做RR(Resource Record，资源记录)。资源记录有很多种类型，比如A、NS、SOA、CNAME 和 PTR 记录；

- 最常见的是A（Address）记录，一条域名到IP地址的映射记录。
- CNAME（Canonical Name）记录是一条从域名到域名的映射记录。在CDN技术中很重要，实现了业务域名和CDN系统的解耦；
- 简单理解如果一个域名配置了A记录，DNS就会把它解析成A记录指定的IP地址；如果一个域名配置了CNAME记录，DNS就会把它解析成CNAME记录指定的另外一个域名；
- A记录和CNAME记录是互斥的，不能同时存在；
- NS(Name Server)记录是和DNS服务器相关的一条记录，它指定该域名应该由哪一台DNS服务器进行解析。一般把通过NS记录指定的DNS服务器叫做该域名的权威DNS服务器；

### 源站
提供原始资源的的业务服务器，可以指定为域名或者IP地址；

### 回源

CDN 节点未缓存请求资源或缓存资源已到期时，回到源站获取资源，返回给客户端；

## 工作原理

### 接入流程
主要步骤：
1. 到某域名供应商处申请一个**加速域名**："js.ss.com"
2. 到阿里云CDN平台添加加速域名"js.ss.com"，同时设置其源站域名为："www.ss.com"
3. 阿里云CDN平台自动分配一个**CNAME域名**："js.ss.com.ali.com"
4. 到域名供应商处给加速域名"js.ss.com"添加**CNAME记录**，其值为上一步得到的CNAME域名："js.ss.com.ali.com"

对以上步骤进一步说明：
- 为了使用CDN，必须另外再申请一个加速域名，作为使用CDN的入口；
- 加速域名配置的是CNAME记录，值为CDN平台提供的CNAME域名，该CNAME域名指向CDN系统节点
- 添加加速域名时需要配置源站域名，据此，CDN平台保存了加速域名与源站域名的映射关系
- CNAME 域名的格式一般时：<加速域名> + <供应商主域名>

### 访问流程
- 第一步访问的时加速域名，不是源站域名；
- 第三步返回CNAME域名；
- 第五步返回CNAME域名对应的IP地址，指向CDN边缘层节点
- 第六步请求的URL(或者说Refer)仍为"js.tt.com/idx.html"
- 第七步请求中心层节点时，会带上第六步的URL作为参数
- 第八步通过查询配置数据得到源站域名，进而向源站发起请求


## 就近访问原理
CNAME域名时CDN供应商提供的，CDN供应商拥有对CNAME域名的配置权，CDN供应商会把CNAME域名的NS记录设置为自己搭建的DNS服务器。这样一来，解析CNAME域名的时候就会请求CDN供应商搭建的DNS服务器。而CDN供应商在DNS服务器中实现了负载均衡，会返回理用户较近的边缘层节点的IP地址；